<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hypertext System Integration Plan v2</title>
    <style>
        :root {
            --chinese-red: #8B0000;
            --chinese-gold: #FFD700;
            --jade-green: #00A86B;
            --ink-black: #2B2B2B;
            --paper-beige: #F5F5DC;
            --light-cream: #FAFAF0;
            --level-1: #000;
            --level-2: #333;
            --level-3: #666;
            --level-4: #999;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background: linear-gradient(135deg, var(--paper-beige) 0%, var(--light-cream) 100%);
            color: var(--ink-black);
            margin: 0;
            padding: 12px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            line-height: 1.4;
            font-size: 14px;
        }

        .container { max-width: 1400px; margin: 0 auto; }

        h1 {
            font-size: 32px;
            font-weight: 900;
            margin: 12px 0;
            padding: 12px;
            background: linear-gradient(135deg, var(--chinese-red), #CD5C5C);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-align: center;
            border-bottom: 3px solid var(--chinese-gold);
        }

        h2 {
            font-size: 20px;
            font-weight: 700;
            margin: 16px 0 8px 0;
            padding: 8px 12px;
            border-left: 4px solid var(--chinese-red);
            background: rgba(139, 0, 0, 0.05);
            color: var(--level-1);
        }

        h3 {
            font-size: 16px;
            font-weight: 600;
            margin: 12px 0 6px 0;
            color: var(--level-2);
            padding-left: 8px;
            border-left: 2px solid var(--chinese-gold);
        }

        h4 {
            font-size: 14px;
            font-weight: 600;
            margin: 8px 0 4px 12px;
            color: var(--level-2);
        }

        .hero {
            background: linear-gradient(135deg, rgba(139, 0, 0, 0.1), rgba(255, 215, 0, 0.1));
            border: 2px solid var(--chinese-gold);
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            text-align: center;
        }

        .hero h2 {
            background: none;
            border: none;
            color: var(--chinese-red);
            margin: 0 0 12px 0;
        }

        .hero p {
            font-size: 16px;
            line-height: 1.6;
            color: var(--level-2);
        }

        .status-badge {
            display: inline-block;
            padding: 6px 16px;
            background: linear-gradient(135deg, var(--jade-green), #00C87A);
            color: white;
            border-radius: 20px;
            font-weight: 700;
            font-size: 14px;
            margin: 12px 0;
            box-shadow: 0 2px 8px rgba(0, 168, 107, 0.3);
        }

        .collapsible {
            margin: 8px 0;
            border: 1px solid rgba(139, 0, 0, 0.2);
            border-radius: 4px;
            overflow: hidden;
        }

        .collapsible-header {
            cursor: pointer;
            padding: 10px 16px;
            background: linear-gradient(135deg, rgba(139, 0, 0, 0.05), rgba(255, 215, 0, 0.02));
            border-left: 4px solid var(--chinese-gold);
            display: flex;
            align-items: center;
            justify-content: space-between;
            user-select: none;
            transition: all 0.2s ease;
            font-weight: 600;
        }

        .collapsible-header:hover {
            background: linear-gradient(135deg, rgba(139, 0, 0, 0.1), rgba(255, 215, 0, 0.05));
        }

        .collapsible-header .arrow {
            display: inline-block;
            transition: transform 0.3s ease;
            color: var(--chinese-red);
            font-size: 14px;
            margin-right: 8px;
        }

        .collapsible.open .arrow {
            transform: rotate(90deg);
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease;
            background: white;
        }

        .collapsible.open .collapsible-content {
            max-height: 10000px;
            padding: 16px;
        }

        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin: 12px 0;
        }

        .card {
            background: white;
            border: 1px solid rgba(139, 0, 0, 0.2);
            border-radius: 6px;
            padding: 12px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
        }

        .card.priority {
            border: 2px solid var(--chinese-gold);
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.05), white);
        }

        .card h4 {
            margin: 0 0 8px 0;
            color: var(--chinese-red);
        }

        pre {
            background: rgba(43, 43, 43, 0.05);
            border: 1px solid rgba(139, 0, 0, 0.1);
            border-left: 3px solid var(--chinese-red);
            padding: 12px;
            overflow-x: auto;
            font-size: 12px;
            line-height: 1.5;
            margin: 8px 0;
            border-radius: 4px;
        }

        code {
            background: rgba(139, 0, 0, 0.05);
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            color: var(--chinese-red);
        }

        ul, ol {
            margin: 8px 0;
            padding-left: 24px;
        }

        li {
            margin: 4px 0;
            line-height: 1.6;
        }

        li strong {
            color: var(--chinese-red);
        }

        .badge {
            display: inline-block;
            padding: 3px 8px;
            background: var(--chinese-red);
            color: white;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
            margin: 0 4px;
        }

        .badge.green { background: var(--jade-green); }
        .badge.gold { background: var(--chinese-gold); color: var(--ink-black); }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 12px 0;
            background: white;
        }

        th, td {
            padding: 8px 12px;
            border: 1px solid rgba(139, 0, 0, 0.2);
            text-align: left;
        }

        th {
            background: linear-gradient(135deg, rgba(139, 0, 0, 0.1), rgba(255, 215, 0, 0.05));
            font-weight: 700;
            color: var(--chinese-red);
        }

        .timeline {
            border-left: 3px solid var(--chinese-gold);
            margin: 16px 0;
            padding-left: 20px;
        }

        .timeline-item {
            margin: 16px 0;
            position: relative;
        }

        .timeline-item:before {
            content: "‚óè";
            position: absolute;
            left: -27px;
            color: var(--chinese-red);
            font-size: 20px;
        }

        .highlight-box {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), white);
            border: 2px solid var(--chinese-gold);
            padding: 16px;
            margin: 16px 0;
            border-radius: 6px;
        }

        .warning-box {
            background: linear-gradient(135deg, rgba(139, 0, 0, 0.05), white);
            border-left: 4px solid var(--chinese-red);
            padding: 12px;
            margin: 12px 0;
        }

        .divider {
            height: 2px;
            background: linear-gradient(90deg, var(--chinese-red), transparent);
            margin: 24px 0;
        }

        .metric {
            display: flex;
            align-items: center;
            margin: 8px 0;
        }

        .metric-label {
            font-weight: 600;
            color: var(--level-2);
            margin-right: 12px;
            min-width: 150px;
        }

        .metric-value {
            color: var(--chinese-red);
            font-weight: 700;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé® Hypertext System Integration Plan v2</h1>

        <div class="hero">
            <h2>Executive Summary</h2>
            <p>Integration plan for key design patterns from NabokovsWeb-hypertext-module into the main extension's element chat system. Focus on <strong>visual indicators</strong> and <strong>inline highlighting</strong> for enhanced user experience.</p>
            <div class="status-badge">‚úÖ READY FOR IMPLEMENTATION</div>
        </div>

        <div class="highlight-box">
            <h3>üîë Key Distinctions: Two Chat Types</h3>
            <div class="two-column">
                <div class="card">
                    <h4>1Ô∏è‚É£ General Element Chats</h4>
                    <ul>
                        <li>User clicks elements to chat</li>
                        <li>Floating chat window</li>
                        <li><strong>After closing:</strong> Small square indicator (30px √ó 30px) at top-right</li>
                        <li><span class="badge">NO</span> hover-to-open behavior</li>
                    </ul>
                </div>
                <div class="card">
                    <h4>2Ô∏è‚É£ Text Selection Chats</h4>
                    <ul>
                        <li>User highlights text to chat</li>
                        <li>Inline highlight + underline (hypertext style)</li>
                        <li>Visual states: loading, active, completed</li>
                        <li>Highlight disappears when archived</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="collapsible open">
            <div class="collapsible-header" onclick="toggleCollapsible(this)">
                <span><span class="arrow">‚ñ∂</span>üìä Analysis Summary</span>
            </div>
            <div class="collapsible-content">
                <p>Based on analysis of <code>../NabokovsWeb-hypertext-module/</code>, the hypertext system excels in:</p>
                <ol>
                    <li><strong>Inline visual indicators</strong> (highlight + underline for text selections)</li>
                    <li><strong>Rich visual state indicators</strong> (5 distinct color-coded states)</li>
                    <li><strong>Clear processing state visualization</strong> (streaming indicators, color changes)</li>
                    <li><strong>Sophisticated context management</strong> with customizable providers</li>
                    <li><strong>Multi-level nested annotations</strong> (up to 5 levels deep)</li>
                    <li><strong>Robust keyboard event handling</strong> with proper preventDefault usage</li>
                </ol>
            </div>
        </div>

        <div class="divider"></div>

        <h2>üéØ Implementation Priorities</h2>

        <div class="collapsible">
            <div class="collapsible-header" onclick="toggleCollapsible(this)">
                <span><span class="arrow">‚ñ∂</span><span class="badge">P1</span> Post-Chat Visual Indicators <span class="badge gold">High Impact, Low Complexity</span></span>
            </div>
            <div class="collapsible-content">
                <h3>Goal</h3>
                <p>Add persistent visual indicators after chats close, with smaller collapsed size.</p>

                <h3>Changes</h3>
                <div class="two-column">
                    <div class="card">
                        <h4>Smaller Collapsed Square</h4>
                        <div class="metric">
                            <span class="metric-label">Previous size:</span>
                            <span class="metric-value">140px √ó 140px</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">New size (30% smaller):</span>
                            <span class="metric-value">100px √ó 100px</span>
                        </div>
                    </div>
                    <div class="card">
                        <h4>Post-Chat Indicator</h4>
                        <div class="metric">
                            <span class="metric-label">Size:</span>
                            <span class="metric-value">30px √ó 30px (30% of collapsed)</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Position:</span>
                            <span class="metric-value">Top-right corner of element</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Interaction:</span>
                            <span class="metric-value">Clickable to reopen</span>
                        </div>
                    </div>
                </div>

                <h3>Color-Coded States</h3>
                <table>
                    <tr>
                        <th>State</th>
                        <th>Color</th>
                        <th>When</th>
                    </tr>
                    <tr>
                        <td><strong>loading</strong></td>
                        <td><code>#6c6c6c</code> (Gray)</td>
                        <td>Chat request in progress</td>
                    </tr>
                    <tr>
                        <td><strong>active</strong></td>
                        <td><code>#b1403c</code> (Dark red)</td>
                        <td>Has conversation</td>
                    </tr>
                    <tr>
                        <td><strong>error</strong></td>
                        <td><code>#b22222</code> (Bright red)</td>
                        <td>Error occurred</td>
                    </tr>
                    <tr>
                        <td><strong>collapsed</strong></td>
                        <td><code>#d4a259</code> (Gold)</td>
                        <td>Window collapsed</td>
                    </tr>
                </table>

                <h3>Key Features</h3>
                <ul>
                    <li><strong>Dynamic positioning:</strong> Updates on scroll & resize with viewport clamping</li>
                    <li><strong>Intersection observer:</strong> Fades (opacity 0.3) when element off-screen</li>
                    <li><strong>Proper cleanup:</strong> Removes event listeners & observers on teardown</li>
                    <li><strong>Horizontal scroll support:</strong> Clamping in page coordinates</li>
                    <li><strong>Skip for text-selection:</strong> Only shows for general element chats</li>
                </ul>

                <h3>Testing</h3>
                <ul class="dense-list">
                    <li>‚úÖ Visual verification: Indicator at top-right</li>
                    <li>‚úÖ Size verification: 30px √ó 30px</li>
                    <li>‚úÖ Click test: Reopens chat</li>
                    <li>‚úÖ State test: Colors match states</li>
                    <li>‚úÖ Scroll test: Repositions correctly</li>
                    <li>‚úÖ Horizontal scroll: Page coordinate clamping</li>
                    <li>‚úÖ Viewport boundaries: Clamps within view</li>
                    <li>‚úÖ Off-screen fade: Opacity reduces</li>
                    <li>‚úÖ Text-selection skip: No indicator for highlights</li>
                </ul>
            </div>
        </div>

        <div class="collapsible">
            <div class="collapsible-header" onclick="toggleCollapsible(this)">
                <span><span class="arrow">‚ñ∂</span><span class="badge">P2</span> Inline Highlighting for Text Selection <span class="badge gold">High Impact, Medium Complexity</span></span>
            </div>
            <div class="collapsible-content">
                <h3>Goal</h3>
                <p>Add hypertext-style inline highlighting for text-selection chats (NOT general element chats).</p>

                <div class="warning-box">
                    <strong>‚ö†Ô∏è Important Distinction:</strong>
                    <ul>
                        <li>General element chats ‚Üí Post-chat indicator only</li>
                        <li>Text selection chats ‚Üí Inline highlight + underline</li>
                    </ul>
                </div>

                <h3>Hypertext Pattern</h3>
                <pre>.hx-highlight {
  text-decoration: underline;
  text-decoration-color: rgba(177, 60, 60, 0.6);
  text-decoration-thickness: 2px;
  background: linear-gradient(to bottom,
    transparent 0%,
    transparent 60%,
    rgba(177, 60, 60, 0.2) 60%,
    rgba(177, 60, 60, 0.2) 100%);
  cursor: pointer;
}</pre>

                <h3>State Transitions</h3>
                <table>
                    <tr>
                        <th>State</th>
                        <th>Background</th>
                        <th>Underline</th>
                    </tr>
                    <tr>
                        <td><strong>loading</strong></td>
                        <td>rgba(108, 108, 108, 0.1)</td>
                        <td>rgba(108, 108, 108, 0.6)</td>
                    </tr>
                    <tr>
                        <td><strong>active</strong></td>
                        <td>rgba(177, 64, 60, 0.15)</td>
                        <td>rgba(177, 64, 60, 0.6)</td>
                    </tr>
                    <tr>
                        <td><strong>error</strong></td>
                        <td>rgba(178, 34, 34, 0.15)</td>
                        <td>rgba(178, 34, 34, 0.6)</td>
                    </tr>
                </table>

                <h3>Activation Methods</h3>
                <div class="two-column">
                    <div class="card priority">
                        <h4>üéπ Keyboard Shortcut</h4>
                        <p><strong>Command+Shift+T</strong></p>
                        <p>Select text, then press shortcut to start chat</p>
                    </div>
                    <div class="card priority">
                        <h4>üñ±Ô∏è Context Menu</h4>
                        <p><strong>"Chat with selection"</strong></p>
                        <p>Right-click selected text, choose menu item</p>
                    </div>
                </div>

                <h3>Key Implementation Details</h3>
                <ul>
                    <li><strong>Range cloning:</strong> Clone original range to avoid mutations</li>
                    <li><strong>Safe wrapping:</strong> Try <code>surroundContents()</code>, fallback for complex selections</li>
                    <li><strong>Z-index ordering:</strong> Later highlights on top (creation time based)</li>
                    <li><strong>Basic context builder:</strong> Phase 2 uses simple context (full provider in Phase 3)</li>
                    <li><strong>Cleanup on archive:</strong> Unwrap highlight when chat closed</li>
                    <li><strong>MutationObserver:</strong> Auto-cleanup when DOM nodes removed</li>
                </ul>

                <h3>Testing</h3>
                <ul class="dense-list">
                    <li>‚úÖ Keyboard activation (Cmd+Shift+T)</li>
                    <li>‚úÖ Context menu activation</li>
                    <li>‚úÖ Highlight + underline renders</li>
                    <li>‚úÖ State color transitions</li>
                    <li>‚úÖ Click to reopen</li>
                    <li>‚úÖ Remove on archive</li>
                    <li>‚úÖ Multiple overlapping highlights</li>
                    <li>‚úÖ Complex cross-element selections</li>
                    <li>‚úÖ DOM mutation cleanup</li>
                </ul>
            </div>
        </div>

        <div class="collapsible">
            <div class="collapsible-header" onclick="toggleCollapsible(this)">
                <span><span class="arrow">‚ñ∂</span><span class="badge">P3</span> Streaming State Visualization <span class="badge">Medium Impact, Low Complexity</span></span>
            </div>
            <div class="collapsible-content">
                <h3>Goal</h3>
                <p>Add visual feedback during streaming with warm background gradient.</p>

                <h3>Streaming CSS (NabokovsWeb Aesthetic)</h3>
                <pre>const chatWindowStyles = {
  streaming: css`
    background: linear-gradient(135deg,
      rgba(255, 250, 247, 1) 0%,
      rgba(255, 245, 240, 1) 100%);
    border-color: rgba(177, 60, 60, 0.6);
    box-shadow:
      0 18px 38px rgba(177, 60, 60, 0.15),
      inset 0 0 0 1px rgba(177, 60, 60, 0.1);
  `
};</pre>

                <h3>Features</h3>
                <ul>
                    <li>Warm gradient background during streaming</li>
                    <li>Pulsing "‚ú® Generating response..." indicator</li>
                    <li>Indicator turns gray (loading state)</li>
                    <li>Send button disabled during streaming</li>
                    <li>Smooth transitions (0.3s ease)</li>
                </ul>
            </div>
        </div>

        <div class="collapsible">
            <div class="collapsible-header" onclick="toggleCollapsible(this)">
                <span><span class="arrow">‚ñ∂</span><span class="badge">P4</span> Enhanced Context Provider <span class="badge">Medium Impact, Medium Complexity</span></span>
            </div>
            <div class="collapsible-content">
                <h3>Goal</h3>
                <p>Implement customizable context providers with truncation options.</p>

                <h3>Context Options</h3>
                <table>
                    <tr>
                        <th>Option</th>
                        <th>Default</th>
                        <th>Description</th>
                    </tr>
                    <tr>
                        <td><code>truncateContext</code></td>
                        <td>true</td>
                        <td>Truncate to maxContextLength</td>
                    </tr>
                    <tr>
                        <td><code>maxContextLength</code></td>
                        <td>200000</td>
                        <td>Max characters (200KB)</td>
                    </tr>
                    <tr>
                        <td><code>includePageText</code></td>
                        <td>true</td>
                        <td>Include full page text</td>
                    </tr>
                    <tr>
                        <td><code>includeElementAncestors</code></td>
                        <td>true</td>
                        <td>Include parent element context</td>
                    </tr>
                </table>

                <h3>Default Context Includes</h3>
                <ul>
                    <li>URL & page title</li>
                    <li>Full page text (if enabled)</li>
                    <li>Element HTML</li>
                    <li>Ancestor context (3 levels)</li>
                    <li>Computed styles</li>
                </ul>

                <h3>Truncation Toggle UI</h3>
                <p>Button in chat window: <strong>üìÑ Full Context</strong> / <strong>üìã Truncated</strong></p>
            </div>
        </div>

        <div class="collapsible">
            <div class="collapsible-header" onclick="toggleCollapsible(this)">
                <span><span class="arrow">‚ñ∂</span><span class="badge">P5</span> Improved Keyboard Handling <span class="badge green">Low Impact, Low Complexity</span></span>
            </div>
            <div class="collapsible-content">
                <h3>Goal</h3>
                <p>Prevent webpage shortcuts from triggering when typing in chat.</p>

                <h3>Keyboard Events</h3>
                <ul>
                    <li><strong>Enter:</strong> Send message (preventDefault)</li>
                    <li><strong>Shift+Enter:</strong> Add newline</li>
                    <li><strong>Escape:</strong> Close window</li>
                    <li><strong>All keys:</strong> stopPropagation to prevent page shortcuts</li>
                </ul>
            </div>
        </div>

        <div class="divider"></div>

        <h2>üó∫Ô∏è Implementation Roadmap</h2>

        <div class="timeline">
            <div class="timeline-item">
                <div class="card priority">
                    <h3>Phase 1: Visual Indicators (1-2 days)</h3>
                    <p><strong>Priority 1:</strong> Post-chat indicators with color-coded states</p>
                    <h4>Deliverables:</h4>
                    <ul>
                        <li>Updated <code>elementChatWindowManager.ts</code> (100px collapsed size)</li>
                        <li>New <code>createPostChatIndicator()</code> in <code>elementChatIndicatorService.ts</code></li>
                        <li>State management for indicator colors</li>
                        <li>Scroll/resize handlers with viewport clamping</li>
                        <li>Cleanup functions for teardown</li>
                        <li>Unit tests for indicator positioning</li>
                        <li>E2E tests for indicator lifecycle (9 test cases)</li>
                    </ul>
                </div>
            </div>

            <div class="timeline-item">
                <div class="card priority">
                    <h3>Phase 2: Text Selection Highlighting (2-3 days)</h3>
                    <p><strong>Priority 2:</strong> Inline highlights with keyboard & context menu activation</p>
                    <h4>Deliverables:</h4>
                    <ul>
                        <li>New <code>textSelectionChatService.ts</code></li>
                        <li>DOM wrapping for text highlights</li>
                        <li>Hypertext-style CSS (underline + background)</li>
                        <li>Keyboard shortcut (Command+Shift+T)</li>
                        <li>Context menu integration</li>
                        <li>Basic selection context builder</li>
                        <li>Highlight state management (loading, active, error)</li>
                        <li>Unit tests for selection wrapping</li>
                        <li>E2E tests for highlight lifecycle (8 test cases)</li>
                    </ul>
                </div>
            </div>

            <div class="timeline-item">
                <div class="card">
                    <h3>Phase 3: Streaming & Context (2-3 days)</h3>
                    <p><strong>Priority 3 + 4:</strong> Streaming visualization & context provider</p>
                    <h4>Deliverables:</h4>
                    <ul>
                        <li>Streaming CSS with NabokovsWeb aesthetic</li>
                        <li>Context provider service (<code>elementChatContextProvider.ts</code>)</li>
                        <li>Truncation toggle UI</li>
                        <li>Ancestor context extraction</li>
                        <li>Unit tests for context building</li>
                        <li>E2E tests for streaming states</li>
                    </ul>
                </div>
            </div>

            <div class="timeline-item">
                <div class="card">
                    <h3>Phase 4: Keyboard Handling (1 day)</h3>
                    <p><strong>Priority 5:</strong> Improved keyboard event handling</p>
                    <h4>Deliverables:</h4>
                    <ul>
                        <li>preventDefault for Enter key</li>
                        <li>Escape key to close</li>
                        <li>stopPropagation for all keyboard events</li>
                        <li>E2E tests for keyboard shortcuts</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="divider"></div>

        <h2>üéØ Success Metrics</h2>

        <div class="two-column">
            <div class="card">
                <h3>Quantitative Metrics</h3>
                <div class="metric">
                    <span class="metric-label">Collapsed square:</span>
                    <span class="metric-value">100px √ó 100px</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Post-chat indicator:</span>
                    <span class="metric-value">30px √ó 30px</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Test coverage:</span>
                    <span class="metric-value">&gt; 80%</span>
                </div>
                <div class="metric">
                    <span class="metric-label">TypeScript errors:</span>
                    <span class="metric-value">Zero</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Console warnings:</span>
                    <span class="metric-value">Zero</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Indicator positioning:</span>
                    <span class="metric-value">&lt; 50ms</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Highlight wrapping:</span>
                    <span class="metric-value">&lt; 100ms</span>
                </div>
            </div>

            <div class="card">
                <h3>Qualitative Metrics</h3>
                <ul>
                    <li>Post-chat indicators provide clear visual feedback</li>
                    <li>Text highlights feel natural and non-intrusive</li>
                    <li>Color-coded states are intuitive</li>
                    <li>Interactions (clicking indicators/highlights) are responsive</li>
                    <li>Context provider API is easy to customize</li>
                    <li>Services are well-documented</li>
                    <li>No breaking changes to existing functionality</li>
                </ul>
            </div>
        </div>

        <div class="divider"></div>

        <h2>‚ùì Open Questions & Decisions</h2>

        <div class="collapsible">
            <div class="collapsible-header" onclick="toggleCollapsible(this)">
                <span><span class="arrow">‚ñ∂</span>1. Text Selection Chat Activation</span>
            </div>
            <div class="collapsible-content">
                <h3>Question</h3>
                <p>Should text selection chat be automatic or require keyboard shortcut?</p>

                <h3>Options</h3>
                <ul>
                    <li><strong>A)</strong> Automatic: Context menu item "Chat with selection"</li>
                    <li><strong>B)</strong> Keyboard: Command+Shift+T after selecting text</li>
                    <li><strong>C)</strong> Both: Context menu + keyboard shortcut</li>
                </ul>

                <div class="highlight-box">
                    <strong>‚úÖ Recommendation:</strong> <strong>Option C</strong> - Both methods for flexibility
                </div>
            </div>
        </div>

        <div class="collapsible">
            <div class="collapsible-header" onclick="toggleCollapsible(this)">
                <span><span class="arrow">‚ñ∂</span>2. Highlight Persistence</span>
            </div>
            <div class="collapsible-content">
                <h3>Question</h3>
                <p>Should highlights persist after page reload?</p>

                <h3>Pros & Cons</h3>
                <div class="two-column">
                    <div class="card">
                        <h4>Pros</h4>
                        <ul>
                            <li>User can revisit highlighted sections</li>
                            <li>Matches hypertext behavior</li>
                        </ul>
                    </div>
                    <div class="card">
                        <h4>Cons</h4>
                        <ul>
                            <li>Requires DOM mutation tracking</li>
                            <li>Complex re-wrapping after page changes</li>
                            <li>Storage overhead</li>
                        </ul>
                    </div>
                </div>

                <div class="highlight-box">
                    <strong>‚úÖ Recommendation:</strong> <strong>No persistence for Phase 1.</strong> Highlights are ephemeral and disappear when chat is closed/archived. Consider persistence in future phase if user feedback requests it.
                </div>
            </div>
        </div>

        <div class="collapsible">
            <div class="collapsible-header" onclick="toggleCollapsible(this)">
                <span><span class="arrow">‚ñ∂</span>3. Post-Chat Indicator Cleanup</span>
            </div>
            <div class="collapsible-content">
                <h3>Question</h3>
                <p>When should post-chat indicators be removed?</p>

                <h3>Options</h3>
                <ul>
                    <li><strong>A)</strong> Never (persist until page reload)</li>
                    <li><strong>B)</strong> After X minutes of inactivity</li>
                    <li><strong>C)</strong> Manual dismiss button on indicator</li>
                </ul>

                <div class="highlight-box">
                    <strong>‚úÖ Recommendation:</strong> <strong>Option A for Phase 1</strong> - Indicators persist until page reload, providing consistent visual reference. Add cleanup options in future phase based on user feedback.
                </div>
            </div>
        </div>

        <div class="collapsible">
            <div class="collapsible-header" onclick="toggleCollapsible(this)">
                <span><span class="arrow">‚ñ∂</span>4. DOM Mutation Handling</span>
            </div>
            <div class="collapsible-content">
                <h3>Question</h3>
                <p>What should happen when the underlying DOM node for an indicator or highlight is removed/re-rendered?</p>

                <h3>Scenarios</h3>
                <ul>
                    <li>SPA (React/Vue) re-renders content</li>
                    <li>User interacts with dynamic page elements</li>
                    <li>Page uses virtual scrolling or lazy loading</li>
                </ul>

                <h3>Options</h3>
                <ul>
                    <li><strong>A)</strong> No cleanup - indicators/highlights become orphaned (may cause visual glitches)</li>
                    <li><strong>B)</strong> MutationObserver - detect DOM changes and remove indicators/highlights</li>
                    <li><strong>C)</strong> MutationObserver + recovery - detect changes and attempt to reattach based on text content</li>
                </ul>

                <div class="highlight-box">
                    <strong>‚úÖ Recommendation:</strong> <strong>Option B for Phase 1</strong> - Use MutationObserver to detect when tracked elements are removed from DOM, then clean up associated indicators/highlights. Option C (recovery) can be added in future phase if user feedback requests it.
                </div>
            </div>
        </div>

        <div class="divider"></div>

        <h2>üìù Next Steps</h2>

        <div class="highlight-box">
            <h3>Immediate Actions</h3>
            <ol>
                <li>‚úÖ <strong>Plan reviewed</strong> (3 Codex review cycles completed)</li>
                <li>‚úÖ <strong>All issues addressed</strong> (positioning, cleanup, context extraction)</li>
                <li>‚è≠Ô∏è <strong>Create GitHub issues</strong> for each phase</li>
                <li>‚è≠Ô∏è <strong>Set up feature flags</strong> in codebase</li>
                <li>‚è≠Ô∏è <strong>Begin Phase 1 implementation</strong></li>
            </ol>
        </div>

        <div class="timeline">
            <div class="timeline-item">
                <div class="card priority">
                    <h3>Phase 1 Kickoff Tasks</h3>
                    <ol>
                        <li>Update collapsed window size in <code>elementChatWindowManager.ts</code></li>
                        <li>Implement <code>createPostChatIndicator()</code> in <code>elementChatIndicatorService.ts</code></li>
                        <li>Add state management for indicator colors</li>
                        <li>Integrate indicator with window close lifecycle</li>
                        <li>Add scroll/resize handlers with viewport clamping</li>
                        <li>Implement cleanup functions</li>
                        <li>Write unit tests for indicator service</li>
                        <li>Write E2E tests for indicator lifecycle</li>
                        <li>Update CLAUDE.md with new features</li>
                    </ol>
                    <p><strong>Estimated Timeline:</strong> 1-2 days</p>
                </div>
            </div>
        </div>

        <div class="divider"></div>

        <div class="hero">
            <h2>‚úÖ Plan Status: Ready for Implementation</h2>
            <p>This plan has been through <strong>3 Codex review cycles</strong> and all technical issues have been addressed. The plan emphasizes:</p>
            <ul style="text-align: left; max-width: 800px; margin: 16px auto;">
                <li><strong>Clear visual feedback</strong> (post-chat indicators, color-coded states)</li>
                <li><strong>Inline highlighting</strong> for text-selection chats (like hypertext)</li>
                <li><strong>Persistent indicators</strong> that remain visible after chats close</li>
                <li><strong>Smaller, less intrusive UI</strong> (30% size reduction)</li>
                <li><strong>Progressive enhancement</strong> (features can be enabled incrementally)</li>
                <li><strong>Backwards compatibility</strong> (no breaking changes)</li>
                <li><strong>Comprehensive testing</strong> (unit + E2E tests for all features)</li>
            </ul>
            <p><strong>Key Differentiator:</strong> Two distinct chat types (general element vs. text selection) with appropriate visual treatments for each.</p>
        </div>
    </div>

    <script>
        function toggleCollapsible(header) {
            const collapsible = header.parentElement;
            collapsible.classList.toggle('open');
        }

        // Auto-expand first few sections on load
        document.addEventListener('DOMContentLoaded', () => {
            const firstCollapsible = document.querySelector('.collapsible');
            if (firstCollapsible) {
                firstCollapsible.classList.add('open');
            }
        });
    </script>
</body>
</html>
